{
    "variables": {
        "mirror": "http://mirrors.kernel.org/archlinux",
        "version": "2018.12.01"
    },

    "builders": [{
        "type": "virtualbox-iso",
        "guest_os_type": "ArchLinux_64",
        "guest_additions_mode": "disable",
        "iso_url": "{{user `mirror`}}/iso/{{user `version`}}/archlinux-{{user `version`}}-x86_64.iso",
        "iso_checksum_url": "{{user `mirror`}}/iso/{{user `version`}}/sha1sums.txt",
        "iso_checksum_type": "sha1",
        "http_directory": "bootstrap",
        "boot_wait": "5s",
        "boot_command": [
            "<enter><wait10><wait10><wait10><wait10>",
            "curl -s http://{{.HTTPIP}}:{{.HTTPPort}}/ssh.sh | bash<enter>"
        ],
        "ssh_timeout": "1m",
        "ssh_username": "vagrant",
        "ssh_password": "vagrant",
        "shutdown_command": "sudo systemctl poweroff"
    }],

    "provisioners": [{
        "type": "shell",
        "script": "install/install.sh",
        "execute_command": "sudo sh -c '{{.Vars}} {{.Path}}'",
        "environment_vars": ["mirror={{user `mirror`}}"]
    }, {
        "type": "shell",
        "script": "install/setup.sh",
        "execute_command": "sudo cp {{.Path}} /mnt/setup.sh && sudo arch-chroot /mnt /setup.sh && sudo rm /mnt/setup.sh && sudo systemctl reboot"
    }, {
        "type": "shell",
        "pause_before": "10s",
        "scripts": [
            "provision/virtualbox.sh",
            "provision/ssh.sh",
            "provision/pacman.sh"
        ]
    }],

    "post-processors": [{
        "type": "vagrant",
        "output": "archlinux-minimal-{{.Provider}}.box"
    }]
}
